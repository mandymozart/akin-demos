"use strict";(self.webpackChunk_scribd_app_monolith=self.webpackChunk_scribd_app_monolith||[]).push([[5327],{15327:(e,t,i)=>{i.d(t,{B:()=>b});var s=i(49526),o=i(94401),n=i(78093),a=i(36442),r=i(95768),l=i(6662),h=i(92834),d=i(32775),c=i(68842),u=i(49173),m=i(42558),p=i(8757),v=i(31936);const f=a.default||a,y="[replayer]",g={duration:500,lineCap:"round",lineWidth:3,strokeStyle:"red"};function S(e){return e.type==d.Bx.IncrementalSnapshot&&(e.data.source==d.Cj.TouchMove||e.data.source==d.Cj.MouseInteraction&&e.data.type==d.T7.TouchStart)}class b{get timer(){return this.service.state.context.timer}constructor(e,t){if(this.usingVirtualDom=!1,this.virtualDom=new n.iw,this.mouseTail=null,this.tailPositions=[],this.emitter=f(),this.legacy_missingNodeRetryMap={},this.cache=(0,o.VC)(),this.imageMap=new Map,this.canvasEventMap=new Map,this.mirror=(0,o.cY)(),this.styleMirror=new c.StyleSheetMirror,this.firstFullSnapshot=null,this.newDocumentQueue=[],this.mousePos=null,this.touchActive=null,this.lastMouseDownEvent=null,this.lastSelectionData=null,this.constructedStyleMutations=[],this.adoptedStyleSheets=[],this.handleResize=e=>{this.iframe.style.display="inherit";for(const t of[this.mouseTail,this.iframe])t&&(t.setAttribute("width",String(e.width)),t.setAttribute("height",String(e.height)))},this.applyEventsSynchronously=e=>{for(const t of e){switch(t.type){case d.Bx.DomContentLoaded:case d.Bx.Load:case d.Bx.Custom:continue;case d.Bx.FullSnapshot:case d.Bx.Meta:case d.Bx.Plugin:case d.Bx.IncrementalSnapshot:}this.getCastFn(t,!0)()}},this.getCastFn=(e,t=!1)=>{let i;switch(e.type){case d.Bx.DomContentLoaded:case d.Bx.Load:break;case d.Bx.Custom:i=()=>{this.emitter.emit(d.Y$.CustomEvent,e)};break;case d.Bx.Meta:i=()=>this.emitter.emit(d.Y$.Resize,{width:e.data.width,height:e.data.height});break;case d.Bx.FullSnapshot:i=()=>{var i;if(this.firstFullSnapshot){if(this.firstFullSnapshot===e)return void(this.firstFullSnapshot=!0)}else this.firstFullSnapshot=!0;this.mediaManager.reset(),this.styleMirror.reset(),this.rebuildFullSnapshot(e,t),null===(i=this.iframe.contentWindow)||void 0===i||i.scrollTo(e.data.initialOffset)};break;case d.Bx.IncrementalSnapshot:i=()=>{if(this.applyIncremental(e,t),!t&&(e===this.nextUserInteractionEvent&&(this.nextUserInteractionEvent=null,this.backToNormal()),this.config.skipInactive&&!this.nextUserInteractionEvent)){for(const t of this.service.state.context.events)if(!(t.timestamp<=e.timestamp)&&this.isUserInteraction(t)){t.delay-e.delay>this.config.inactivePeriodThreshold*this.speedService.state.context.timer.speed&&(this.nextUserInteractionEvent=t);break}if(this.nextUserInteractionEvent){const t=this.nextUserInteractionEvent.delay-e.delay,i={speed:Math.min(Math.round(t/5e3),this.config.maxSpeed)};this.speedService.send({type:"FAST_FORWARD",payload:i}),this.emitter.emit(d.Y$.SkipStart,i)}}}}return()=>{i&&i();for(const i of this.config.plugins||[])i.handler&&i.handler(e,t,{replayer:this});this.service.send({type:"CAST_EVENT",payload:{event:e}});const s=this.service.state.context.events.length-1;if(!this.config.liveMode&&e===this.service.state.context.events[s]){const t=()=>{s<this.service.state.context.events.length-1||(this.backToNormal(),this.service.send("END"),this.emitter.emit(d.Y$.Finish))};let i=50;e.type===d.Bx.IncrementalSnapshot&&e.data.source===d.Cj.MouseMove&&e.data.positions.length&&(i+=Math.max(0,-e.data.positions[0].timeOffset)),setTimeout(t,i)}this.emitter.emit(d.Y$.EventCast,e)}},!(null==t?void 0:t.liveMode)&&e.length<2)throw new Error("Replayer need at least 2 events.");const i={speed:1,maxSpeed:360,root:document.body,loadTimeout:0,skipInactive:!1,inactivePeriodThreshold:1e4,showWarning:!0,showDebug:!1,blockClass:"rr-block",liveMode:!1,insertStyleRules:[],triggerFocus:!0,UNSAFE_replayCanvas:!1,pauseAnimation:!0,mouseTail:g,useVirtualDom:!0,logger:console};this.config=Object.assign({},i,t),this.handleResize=this.handleResize.bind(this),this.getCastFn=this.getCastFn.bind(this),this.applyEventsSynchronously=this.applyEventsSynchronously.bind(this),this.emitter.on(d.Y$.Resize,this.handleResize),this.setupDom();for(const e of this.config.plugins||[])e.getMirror&&e.getMirror({nodeMirror:this.mirror});this.emitter.on(d.Y$.Flush,(()=>{if(this.usingVirtualDom){const e={mirror:this.mirror,applyCanvas:(e,t,i)=>{(0,m.A)({event:e,mutation:t,target:i,imageMap:this.imageMap,canvasEventMap:this.canvasEventMap,errorHandler:this.warnCanvasMutationFailed.bind(this)})},applyInput:this.applyInput.bind(this),applyScroll:this.applyScroll.bind(this),applyStyleSheetMutation:(e,t)=>{e.source===d.Cj.StyleSheetRule?this.applyStyleSheetRule(e,t):e.source===d.Cj.StyleDeclaration&&this.applyStyleDeclaration(e,t)},afterAppend:(e,t)=>{for(const i of this.config.plugins||[])i.onBuild&&i.onBuild(e,{id:t,replayer:this})}};if(this.iframe.contentDocument)try{(0,n.Ui)(this.iframe.contentDocument,this.virtualDom,e,this.virtualDom.mirror)}catch(e){console.warn(e)}if(this.virtualDom.destroyTree(),this.usingVirtualDom=!1,Object.keys(this.legacy_missingNodeRetryMap).length)for(const t in this.legacy_missingNodeRetryMap)try{const i=this.legacy_missingNodeRetryMap[t],s=(0,n.iU)(i.node,this.mirror,this.virtualDom.mirror);(0,n.Ui)(s,i.node,e,this.virtualDom.mirror),i.node=s}catch(e){this.warn(e)}this.constructedStyleMutations.forEach((e=>{this.applyStyleSheetMutation(e)})),this.constructedStyleMutations=[],this.adoptedStyleSheets.forEach((e=>{this.applyAdoptedStyleSheet(e)})),this.adoptedStyleSheets=[]}if(this.mousePos&&(this.moveAndHover(this.mousePos.x,this.mousePos.y,this.mousePos.id,!0,this.mousePos.debugData),this.mousePos=null),!0===this.touchActive?this.mouse.classList.add("touch-active"):!1===this.touchActive&&this.mouse.classList.remove("touch-active"),this.touchActive=null,this.lastMouseDownEvent){const[e,t]=this.lastMouseDownEvent;e.dispatchEvent(t)}this.lastMouseDownEvent=null,this.lastSelectionData&&(this.applySelection(this.lastSelectionData),this.lastSelectionData=null)})),this.emitter.on(d.Y$.PlayBack,(()=>{this.firstFullSnapshot=null,this.mirror.reset(),this.styleMirror.reset(),this.mediaManager.reset()}));const s=new l.M([],{speed:this.config.speed});this.service=(0,h.JT)({events:e.map((e=>t&&t.unpackFn?t.unpackFn(e):e)).sort(((e,t)=>e.timestamp-t.timestamp)),timer:s,timeOffset:0,baselineTime:0,lastPlayedEvent:null},{getCastFn:this.getCastFn,applyEventsSynchronously:this.applyEventsSynchronously,emitter:this.emitter}),this.service.start(),this.service.subscribe((e=>{this.emitter.emit(d.Y$.StateChange,{player:e})})),this.speedService=(0,h.ZT)({normalSpeed:-1,timer:s}),this.speedService.start(),this.speedService.subscribe((e=>{this.emitter.emit(d.Y$.StateChange,{speed:e})})),this.mediaManager=new v.g({warn:this.warn.bind(this),service:this.service,speedService:this.speedService,emitter:this.emitter,getCurrentTime:this.getCurrentTime.bind(this)});const a=this.service.state.context.events.find((e=>e.type===d.Bx.Meta)),r=this.service.state.context.events.find((e=>e.type===d.Bx.FullSnapshot));if(a){const{width:e,height:t}=a.data;setTimeout((()=>{this.emitter.emit(d.Y$.Resize,{width:e,height:t})}),0)}r&&setTimeout((()=>{var e;this.firstFullSnapshot||(this.firstFullSnapshot=r,this.rebuildFullSnapshot(r),null===(e=this.iframe.contentWindow)||void 0===e||e.scrollTo(r.data.initialOffset))}),1),this.service.state.context.events.find(S)&&this.mouse.classList.add("touch-device")}on(e,t){return this.emitter.on(e,t),this}off(e,t){return this.emitter.off(e,t),this}setConfig(e){Object.keys(e).forEach((t=>{e[t],this.config[t]=e[t]})),this.config.skipInactive||this.backToNormal(),void 0!==e.speed&&this.speedService.send({type:"SET_SPEED",payload:{speed:e.speed}}),void 0!==e.mouseTail&&(!1===e.mouseTail?this.mouseTail&&(this.mouseTail.style.display="none"):(this.mouseTail||(this.mouseTail=document.createElement("canvas"),this.mouseTail.width=Number.parseFloat(this.iframe.width),this.mouseTail.height=Number.parseFloat(this.iframe.height),this.mouseTail.classList.add("replayer-mouse-tail"),this.wrapper.insertBefore(this.mouseTail,this.iframe)),this.mouseTail.style.display="inherit"))}getMetaData(){const e=this.service.state.context.events[0],t=this.service.state.context.events[this.service.state.context.events.length-1];return{startTime:e.timestamp,endTime:t.timestamp,totalTime:t.timestamp-e.timestamp}}getCurrentTime(){return this.timer.timeOffset+this.getTimeOffset()}getTimeOffset(){const{baselineTime:e,events:t}=this.service.state.context;return e-t[0].timestamp}getMirror(){return this.mirror}play(e=0){var t,i;this.service.state.matches("paused")||this.service.send({type:"PAUSE"}),this.service.send({type:"PLAY",payload:{timeOffset:e}}),null===(i=null===(t=this.iframe.contentDocument)||void 0===t?void 0:t.getElementsByTagName("html")[0])||void 0===i||i.classList.remove("rrweb-paused"),this.emitter.emit(d.Y$.Start)}pause(e){var t,i;void 0===e&&this.service.state.matches("playing")&&this.service.send({type:"PAUSE"}),"number"==typeof e&&(this.play(e),this.service.send({type:"PAUSE"})),null===(i=null===(t=this.iframe.contentDocument)||void 0===t?void 0:t.getElementsByTagName("html")[0])||void 0===i||i.classList.add("rrweb-paused"),this.emitter.emit(d.Y$.Pause)}resume(e=0){this.warn("The 'resume' was deprecated in 1.0. Please use 'play' method which has the same interface."),this.play(e),this.emitter.emit(d.Y$.Resume)}destroy(){this.pause(),this.mirror.reset(),this.styleMirror.reset(),this.mediaManager.reset(),this.config.root.removeChild(this.wrapper),this.emitter.emit(d.Y$.Destroy)}startLive(e){this.service.send({type:"TO_LIVE",payload:{baselineTime:e}})}addEvent(e){const t=this.config.unpackFn?this.config.unpackFn(e):e;S(t)&&this.mouse.classList.add("touch-device"),Promise.resolve().then((()=>this.service.send({type:"ADD_EVENT",payload:{event:t}})))}enableInteract(){this.iframe.setAttribute("scrolling","auto"),this.iframe.style.pointerEvents="auto"}disableInteract(){this.iframe.setAttribute("scrolling","no"),this.iframe.style.pointerEvents="none"}resetCache(){this.cache=(0,o.VC)()}setupDom(){this.wrapper=document.createElement("div"),this.wrapper.classList.add("replayer-wrapper"),this.config.root.appendChild(this.wrapper),this.mouse=document.createElement("div"),this.mouse.classList.add("replayer-mouse"),this.wrapper.appendChild(this.mouse),!1!==this.config.mouseTail&&(this.mouseTail=document.createElement("canvas"),this.mouseTail.classList.add("replayer-mouse-tail"),this.mouseTail.style.display="inherit",this.wrapper.appendChild(this.mouseTail)),this.iframe=document.createElement("iframe");const e=["allow-same-origin"];this.config.UNSAFE_replayCanvas&&e.push("allow-scripts"),this.iframe.style.display="none",this.iframe.setAttribute("sandbox",e.join(" ")),this.disableInteract(),this.wrapper.appendChild(this.iframe),this.iframe.contentWindow&&this.iframe.contentDocument&&((0,r.M)(this.iframe.contentWindow,this.iframe.contentDocument),(0,c.polyfill)(this.iframe.contentWindow))}rebuildFullSnapshot(e,t=!1){if(!this.iframe.contentDocument)return this.warn("Looks like your replayer has been destroyed.");Object.keys(this.legacy_missingNodeRetryMap).length&&this.warn("Found unresolved missing node map",this.legacy_missingNodeRetryMap),this.legacy_missingNodeRetryMap={};const i=[],s=(t,s)=>{if(this.collectIframeAndAttachDocument(i,t),this.mediaManager.isSupportedMediaElement(t)){const{events:i}=this.service.state.context;this.mediaManager.addMediaElements(t,e.timestamp-i[0].timestamp,this.mirror)}for(const e of this.config.plugins||[])e.onBuild&&e.onBuild(t,{id:s,replayer:this})};this.usingVirtualDom&&(this.virtualDom.destroyTree(),this.usingVirtualDom=!1),this.mirror.reset(),(0,o.J4)(e.data.node,{doc:this.iframe.contentDocument,afterAppend:s,cache:this.cache,mirror:this.mirror}),s(this.iframe.contentDocument,e.data.node.id);for(const{mutationInQueue:e,builtNode:t}of i)this.attachDocumentToIframe(e,t),this.newDocumentQueue=this.newDocumentQueue.filter((t=>t!==e));const{documentElement:n,head:a}=this.iframe.contentDocument;this.insertStyleRules(n,a),this.service.state.matches("playing")||this.iframe.contentDocument.getElementsByTagName("html")[0].classList.add("rrweb-paused"),this.emitter.emit(d.Y$.FullsnapshotRebuilded,e),t||this.waitForStylesheetLoad(),this.config.UNSAFE_replayCanvas&&this.preloadAllImages()}insertStyleRules(e,t){var i;const s=(0,u.A)(this.config.blockClass).concat(this.config.insertStyleRules);if(this.config.pauseAnimation&&s.push("html.rrweb-paused *, html.rrweb-paused *:before, html.rrweb-paused *:after { animation-play-state: paused !important; }"),this.usingVirtualDom){const i=this.virtualDom.createElement("style");this.virtualDom.mirror.add(i,(0,n.jz)(i,this.virtualDom.unserializedId)),e.insertBefore(i,t),i.rules.push({source:d.Cj.StyleSheetRule,adds:s.map(((e,t)=>({rule:e,index:t})))})}else{const o=document.createElement("style");e.insertBefore(o,t);for(let e=0;e<s.length;e++)null===(i=o.sheet)||void 0===i||i.insertRule(s[e],e)}}attachDocumentToIframe(e,t){const i=this.usingVirtualDom?this.virtualDom.mirror:this.mirror,s=[],n=(e,n)=>{this.collectIframeAndAttachDocument(s,e);const a=i.getMeta(e);if((null==a?void 0:a.type)===o.Z6.Element&&"HTML"===(null==a?void 0:a.tagName.toUpperCase())){const{documentElement:e,head:i}=t.contentDocument;this.insertStyleRules(e,i)}if(!this.usingVirtualDom)for(const t of this.config.plugins||[])t.onBuild&&t.onBuild(e,{id:n,replayer:this})};(0,o.gO)(e.node,{doc:t.contentDocument,mirror:i,hackCss:!0,skipChild:!1,afterAppend:n,cache:this.cache}),n(t.contentDocument,e.node.id);for(const{mutationInQueue:e,builtNode:t}of s)this.attachDocumentToIframe(e,t),this.newDocumentQueue=this.newDocumentQueue.filter((t=>t!==e))}collectIframeAndAttachDocument(e,t){if((0,c.isSerializedIframe)(t,this.mirror)){const i=this.newDocumentQueue.find((e=>e.parentId===this.mirror.getId(t)));i&&e.push({mutationInQueue:i,builtNode:t})}}waitForStylesheetLoad(){var e;const t=null===(e=this.iframe.contentDocument)||void 0===e?void 0:e.head;if(t){const e=new Set;let i,s=this.service.state;const o=()=>{s=this.service.state};this.emitter.on(d.Y$.Start,o),this.emitter.on(d.Y$.Pause,o);const n=()=>{this.emitter.off(d.Y$.Start,o),this.emitter.off(d.Y$.Pause,o)};t.querySelectorAll('link[rel="stylesheet"]').forEach((t=>{t.sheet||(e.add(t),t.addEventListener("load",(()=>{e.delete(t),0===e.size&&-1!==i&&(s.matches("playing")&&this.play(this.getCurrentTime()),this.emitter.emit(d.Y$.LoadStylesheetEnd),i&&clearTimeout(i),n())})))})),e.size>0&&(this.service.send({type:"PAUSE"}),this.emitter.emit(d.Y$.LoadStylesheetStart),i=setTimeout((()=>{s.matches("playing")&&this.play(this.getCurrentTime()),i=-1,n()}),this.config.loadTimeout))}}preloadAllImages(){return(0,s.s)(this,void 0,void 0,(function*(){this.service.state;const e=()=>{this.service.state};this.emitter.on(d.Y$.Start,e),this.emitter.on(d.Y$.Pause,e);const t=[];for(const e of this.service.state.context.events)if(e.type===d.Bx.IncrementalSnapshot&&e.data.source===d.Cj.CanvasMutation){t.push(this.deserializeAndPreloadCanvasEvents(e.data,e));("commands"in e.data?e.data.commands:[e.data]).forEach((t=>{this.preloadImages(t,e)}))}return Promise.all(t)}))}preloadImages(e,t){if("drawImage"===e.property&&"string"==typeof e.args[0]&&!this.imageMap.has(t)){const t=document.createElement("canvas"),i=t.getContext("2d"),s=null==i?void 0:i.createImageData(t.width,t.height);null==s||s.data,JSON.parse(e.args[0]),null==i||i.putImageData(s,0,0)}}deserializeAndPreloadCanvasEvents(e,t){return(0,s.s)(this,void 0,void 0,(function*(){if(!this.canvasEventMap.has(t)){const i={isUnchanged:!0};if("commands"in e){const o=yield Promise.all(e.commands.map((e=>(0,s.s)(this,void 0,void 0,(function*(){const t=yield Promise.all(e.args.map((0,p.g)(this.imageMap,null,i)));return Object.assign(Object.assign({},e),{args:t})})))));!1===i.isUnchanged&&this.canvasEventMap.set(t,Object.assign(Object.assign({},e),{commands:o}))}else{const s=yield Promise.all(e.args.map((0,p.g)(this.imageMap,null,i)));!1===i.isUnchanged&&this.canvasEventMap.set(t,Object.assign(Object.assign({},e),{args:s}))}}}))}applyIncremental(e,t){var i,s,n;const{data:a}=e;switch(a.source){case d.Cj.Mutation:try{this.applyMutation(a,t)}catch(e){this.warn(`Exception in mutation ${e.message||e}`,a)}break;case d.Cj.Drag:case d.Cj.TouchMove:case d.Cj.MouseMove:if(t){const e=a.positions[a.positions.length-1];this.mousePos={x:e.x,y:e.y,id:e.id,debugData:a}}else a.positions.forEach((i=>{const s={doAction:()=>{this.moveAndHover(i.x,i.y,i.id,t,a)},delay:i.timeOffset+e.timestamp-this.service.state.context.baselineTime};this.timer.addAction(s)})),this.timer.addAction({doAction(){},delay:e.delay-(null===(i=a.positions[0])||void 0===i?void 0:i.timeOffset)});break;case d.Cj.MouseInteraction:{if(-1===a.id)break;const e=new Event((0,o.PX)(d.T7[a.type])),i=this.mirror.getNode(a.id);if(!i)return this.debugNodeNotFound(a,a.id);this.emitter.emit(d.Y$.MouseInteraction,{type:a.type,target:i});const{triggerFocus:s}=this.config;switch(a.type){case d.T7.Blur:"blur"in i&&i.blur();break;case d.T7.Focus:s&&i.focus&&i.focus({preventScroll:!0});break;case d.T7.Click:case d.T7.TouchStart:case d.T7.TouchEnd:case d.T7.MouseDown:case d.T7.MouseUp:t?(a.type===d.T7.TouchStart?this.touchActive=!0:a.type===d.T7.TouchEnd&&(this.touchActive=!1),a.type===d.T7.MouseDown?this.lastMouseDownEvent=[i,e]:a.type===d.T7.MouseUp&&(this.lastMouseDownEvent=null),this.mousePos={x:a.x||0,y:a.y||0,id:a.id,debugData:a}):(a.type===d.T7.TouchStart&&(this.tailPositions.length=0),this.moveAndHover(a.x||0,a.y||0,a.id,t,a),a.type===d.T7.Click?(this.mouse.classList.remove("active"),this.mouse.offsetWidth,this.mouse.classList.add("active")):a.type===d.T7.TouchStart?(this.mouse.offsetWidth,this.mouse.classList.add("touch-active")):a.type===d.T7.TouchEnd?this.mouse.classList.remove("touch-active"):i.dispatchEvent(e));break;case d.T7.TouchCancel:t?this.touchActive=!1:this.mouse.classList.remove("touch-active");break;default:i.dispatchEvent(e)}break}case d.Cj.Scroll:if(-1===a.id)break;if(this.usingVirtualDom){const e=this.virtualDom.mirror.getNode(a.id);if(!e)return this.debugNodeNotFound(a,a.id);e.scrollData=a;break}this.applyScroll(a,t);break;case d.Cj.ViewportResize:this.emitter.emit(d.Y$.Resize,{width:a.width,height:a.height});break;case d.Cj.Input:if(-1===a.id)break;if(this.usingVirtualDom){const e=this.virtualDom.mirror.getNode(a.id);if(!e)return this.debugNodeNotFound(a,a.id);e.inputData=a;break}this.applyInput(a);break;case d.Cj.MediaInteraction:{const t=this.usingVirtualDom?this.virtualDom.mirror.getNode(a.id):this.mirror.getNode(a.id);if(!t)return this.debugNodeNotFound(a,a.id);const i=t,{events:s}=this.service.state.context;this.mediaManager.mediaMutation({target:i,timeOffset:e.timestamp-s[0].timestamp,mutation:a});break}case d.Cj.StyleSheetRule:case d.Cj.StyleDeclaration:this.usingVirtualDom?a.styleId?this.constructedStyleMutations.push(a):a.id&&(null===(s=this.virtualDom.mirror.getNode(a.id))||void 0===s||s.rules.push(a)):this.applyStyleSheetMutation(a);break;case d.Cj.CanvasMutation:if(!this.config.UNSAFE_replayCanvas)return;if(this.usingVirtualDom){const t=this.virtualDom.mirror.getNode(a.id);if(!t)return this.debugNodeNotFound(a,a.id);t.canvasMutations.push({event:e,mutation:a})}else{const t=this.mirror.getNode(a.id);if(!t)return this.debugNodeNotFound(a,a.id);(0,m.A)({event:e,mutation:a,target:t,imageMap:this.imageMap,canvasEventMap:this.canvasEventMap,errorHandler:this.warnCanvasMutationFailed.bind(this)})}break;case d.Cj.Font:try{const e=new FontFace(a.family,a.buffer?new Uint8Array(JSON.parse(a.fontSource)):a.fontSource,a.descriptors);null===(n=this.iframe.contentDocument)||void 0===n||n.fonts.add(e)}catch(e){this.warn(e)}break;case d.Cj.Selection:if(t){this.lastSelectionData=a;break}this.applySelection(a);break;case d.Cj.AdoptedStyleSheet:this.usingVirtualDom?this.adoptedStyleSheets.push(a):this.applyAdoptedStyleSheet(a)}}applyMutation(e,t){if(this.config.useVirtualDom&&!this.usingVirtualDom&&t&&(this.usingVirtualDom=!0,(0,n.Td)(this.iframe.contentDocument,this.mirror,this.virtualDom),Object.keys(this.legacy_missingNodeRetryMap).length))for(const e in this.legacy_missingNodeRetryMap)try{const t=this.legacy_missingNodeRetryMap[e],i=(0,n.$8)(t.node,this.virtualDom,this.mirror);i&&(t.node=i)}catch(e){this.warn(e)}const i=this.usingVirtualDom?this.virtualDom.mirror:this.mirror;e.removes=e.removes.filter((t=>!!i.getNode(t.id)||(this.warnNodeNotFound(e,t.id),!1))),e.removes.forEach((t=>{var s;const o=i.getNode(t.id);if(!o)return;let n=i.getNode(t.parentId);if(!n)return this.warnNodeNotFound(e,t.parentId);if(t.isShadow&&(0,c.hasShadowRoot)(n)&&(n=n.shadowRoot),i.removeNodeFromMap(o),n)try{n.removeChild(o),this.usingVirtualDom&&"#text"===o.nodeName&&"STYLE"===n.nodeName&&(null===(s=n.rules)||void 0===s?void 0:s.length)>0&&(n.rules=[])}catch(t){if(!(t instanceof DOMException))throw t;this.warn("parent could not remove child in mutation",n,o,e)}}));const s=Object.assign({},this.legacy_missingNodeRetryMap),a=[],r=e=>{var t,n;if(!this.iframe.contentDocument)return this.warn("Looks like your replayer has been destroyed.");let r=i.getNode(e.parentId);if(!r)return e.node.type===o.Z6.Document?this.newDocumentQueue.push(e):a.push(e);e.node.isShadow&&((0,c.hasShadowRoot)(r)||r.attachShadow({mode:"open"}),r=r.shadowRoot);let l=null,h=null;if(e.previousId&&(l=i.getNode(e.previousId)),e.nextId&&(h=i.getNode(e.nextId)),(e=>{let t=null;return e.nextId&&(t=i.getNode(e.nextId)),null!==e.nextId&&void 0!==e.nextId&&-1!==e.nextId&&!t})(e))return a.push(e);if(e.node.rootId&&!i.getNode(e.node.rootId))return;const d=e.node.rootId?i.getNode(e.node.rootId):this.usingVirtualDom?this.virtualDom:this.iframe.contentDocument;if((0,c.isSerializedIframe)(r,i))return void this.attachDocumentToIframe(e,r);const u=(e,t)=>{if(!this.usingVirtualDom)for(const i of this.config.plugins||[])i.onBuild&&i.onBuild(e,{id:t,replayer:this})},m=(0,o.gO)(e.node,{doc:d,mirror:i,skipChild:!0,hackCss:!0,cache:this.cache,afterAppend:u});if(-1===e.previousId||-1===e.nextId)return void(s[e.node.id]={node:m,mutation:e});const p=i.getMeta(r);if(p&&p.type===o.Z6.Element&&"textarea"===p.tagName&&e.node.type===o.Z6.Text){const e=Array.isArray(r.childNodes)?r.childNodes:Array.from(r.childNodes);for(const t of e)t.nodeType===r.TEXT_NODE&&r.removeChild(t)}else if((null==p?void 0:p.type)===o.Z6.Document){const i=r;e.node.type===o.Z6.DocumentType&&(null===(t=i.childNodes[0])||void 0===t?void 0:t.nodeType)===Node.DOCUMENT_TYPE_NODE&&i.removeChild(i.childNodes[0]),"HTML"===m.nodeName&&i.documentElement&&i.removeChild(i.documentElement)}if(l&&l.nextSibling&&l.nextSibling.parentNode?r.insertBefore(m,l.nextSibling):h&&h.parentNode?r.contains(h)?r.insertBefore(m,h):r.insertBefore(m,null):r.appendChild(m),u(m,e.node.id),this.usingVirtualDom&&"#text"===m.nodeName&&"STYLE"===r.nodeName&&(null===(n=r.rules)||void 0===n?void 0:n.length)>0&&(r.rules=[]),(0,c.isSerializedIframe)(m,this.mirror)){const e=this.mirror.getId(m),t=this.newDocumentQueue.find((t=>t.parentId===e));t&&(this.attachDocumentToIframe(t,m),this.newDocumentQueue=this.newDocumentQueue.filter((e=>e!==t)))}(e.previousId||e.nextId)&&this.legacy_resolveMissingNode(s,r,m,e)};e.adds.forEach((e=>{r(e)}));const l=Date.now();for(;a.length;){const e=(0,c.queueToResolveTrees)(a);if(a.length=0,Date.now()-l>500){this.warn("Timeout in the loop, please check the resolve tree data:",e);break}for(const t of e){i.getNode(t.value.parentId)?(0,c.iterateResolveTree)(t,(e=>{r(e)})):this.debug("Drop resolve tree since there is no parent for the root node.",t)}}Object.keys(s).length&&Object.assign(this.legacy_missingNodeRetryMap,s),(0,c.uniqueTextMutations)(e.texts).forEach((t=>{var s;const o=i.getNode(t.id);if(!o){if(e.removes.find((e=>e.id===t.id)))return;return this.warnNodeNotFound(e,t.id)}if(o.textContent=t.value,this.usingVirtualDom){const e=o.parentNode;(null===(s=null==e?void 0:e.rules)||void 0===s?void 0:s.length)>0&&(e.rules=[])}})),e.attributes.forEach((t=>{var s;const n=i.getNode(t.id);if(!n){if(e.removes.find((e=>e.id===t.id)))return;return this.warnNodeNotFound(e,t.id)}for(const e in t.attributes)if("string"==typeof e){const a=t.attributes[e];if(null===a)n.removeAttribute(e);else if("string"==typeof a)try{if("_cssText"===e&&("LINK"===n.nodeName||"STYLE"===n.nodeName))try{const e=i.getMeta(n);Object.assign(e.attributes,t.attributes);const s=(0,o.gO)(e,{doc:n.ownerDocument,mirror:i,skipChild:!0,hackCss:!0,cache:this.cache}),a=n.nextSibling,r=n.parentNode;if(s&&r){r.removeChild(n),r.insertBefore(s,a),i.replace(t.id,s);break}}catch(e){}if("value"===e&&"TEXTAREA"===n.nodeName){const e=n;e.childNodes.forEach((t=>e.removeChild(t)));const t=null===(s=n.ownerDocument)||void 0===s?void 0:s.createTextNode(a);t&&e.appendChild(t)}else n.setAttribute(e,a)}catch(e){this.warn("An error occurred may due to the checkout feature.",e)}else if("style"===e){const e=a,t=n;for(const i in e)if(!1===e[i])t.style.removeProperty(i);else if(e[i]instanceof Array){const s=e[i];t.style.setProperty(i,s[0],s[1])}else{const s=e[i];t.style.setProperty(i,s)}}}}))}applyScroll(e,t){var i,s;const n=this.mirror.getNode(e.id);if(!n)return this.debugNodeNotFound(e,e.id);const a=this.mirror.getMeta(n);if(n===this.iframe.contentDocument)null===(i=this.iframe.contentWindow)||void 0===i||i.scrollTo({top:e.y,left:e.x,behavior:t?"auto":"smooth"});else if((null==a?void 0:a.type)===o.Z6.Document)null===(s=n.defaultView)||void 0===s||s.scrollTo({top:e.y,left:e.x,behavior:t?"auto":"smooth"});else try{n.scrollTo({top:e.y,left:e.x,behavior:t?"auto":"smooth"})}catch(e){}}applyInput(e){const t=this.mirror.getNode(e.id);if(!t)return this.debugNodeNotFound(e,e.id);try{t.checked=e.isChecked,t.value=e.text}catch(e){}}applySelection(e){try{const t=new Set,i=e.ranges.map((({start:e,startOffset:i,end:s,endOffset:o})=>{const n=this.mirror.getNode(e),a=this.mirror.getNode(s);if(!n||!a)return;const r=new Range;r.setStart(n,i),r.setEnd(a,o);const l=n.ownerDocument,h=null==l?void 0:l.getSelection();return h&&t.add(h),{range:r,selection:h}}));t.forEach((e=>e.removeAllRanges())),i.forEach((e=>{var t;return e&&(null===(t=e.selection)||void 0===t?void 0:t.addRange(e.range))}))}catch(e){}}applyStyleSheetMutation(e){var t;let i=null;e.styleId?i=this.styleMirror.getStyle(e.styleId):e.id&&(i=(null===(t=this.mirror.getNode(e.id))||void 0===t?void 0:t.sheet)||null),i&&(e.source===d.Cj.StyleSheetRule?this.applyStyleSheetRule(e,i):e.source===d.Cj.StyleDeclaration&&this.applyStyleDeclaration(e,i))}applyStyleSheetRule(e,t){var i,s,o,n;if(null===(i=e.adds)||void 0===i||i.forEach((({rule:e,index:i})=>{try{if(Array.isArray(i)){const{positions:s,index:o}=(0,c.getPositionsAndIndex)(i);(0,c.getNestedRule)(t.cssRules,s).insertRule(e,o)}else{const s=void 0===i?void 0:Math.min(i,t.cssRules.length);null==t||t.insertRule(e,s)}}catch(e){}})),null===(s=e.removes)||void 0===s||s.forEach((({index:e})=>{try{if(Array.isArray(e)){const{positions:i,index:s}=(0,c.getPositionsAndIndex)(e);(0,c.getNestedRule)(t.cssRules,i).deleteRule(s||0)}else null==t||t.deleteRule(e)}catch(e){}})),e.replace)try{null===(o=t.replace)||void 0===o||o.call(t,e.replace)}catch(e){}if(e.replaceSync)try{null===(n=t.replaceSync)||void 0===n||n.call(t,e.replaceSync)}catch(e){}}applyStyleDeclaration(e,t){if(e.set){(0,c.getNestedRule)(t.rules,e.index).style.setProperty(e.set.property,e.set.value,e.set.priority)}if(e.remove){(0,c.getNestedRule)(t.rules,e.index).style.removeProperty(e.remove.property)}}applyAdoptedStyleSheet(e){var t;const i=this.mirror.getNode(e.id);if(!i)return;null===(t=e.styles)||void 0===t||t.forEach((e=>{var t;let s=null,o=null;if((0,c.hasShadowRoot)(i)?o=(null===(t=i.ownerDocument)||void 0===t?void 0:t.defaultView)||null:"#document"===i.nodeName&&(o=i.defaultView),o)try{s=new o.CSSStyleSheet,this.styleMirror.add(s,e.styleId),this.applyStyleSheetRule({source:d.Cj.StyleSheetRule,adds:e.rules},s)}catch(e){}}));let s=0;const o=(e,t)=>{const i=t.map((e=>this.styleMirror.getStyle(e))).filter((e=>null!==e));(0,c.hasShadowRoot)(e)?e.shadowRoot.adoptedStyleSheets=i:"#document"===e.nodeName&&(e.adoptedStyleSheets=i),i.length!==t.length&&s<10&&(setTimeout((()=>o(e,t)),0+100*s),s++)};o(i,e.styleIds)}legacy_resolveMissingNode(e,t,i,s){const{previousId:o,nextId:n}=s,a=o&&e[o],r=n&&e[n];if(a){const{node:s,mutation:o}=a;t.insertBefore(s,i),delete e[o.node.id],delete this.legacy_missingNodeRetryMap[o.node.id],(o.previousId||o.nextId)&&this.legacy_resolveMissingNode(e,t,s,o)}if(r){const{node:s,mutation:o}=r;t.insertBefore(s,i.nextSibling),delete e[o.node.id],delete this.legacy_missingNodeRetryMap[o.node.id],(o.previousId||o.nextId)&&this.legacy_resolveMissingNode(e,t,s,o)}}moveAndHover(e,t,i,s,o){const n=this.mirror.getNode(i);if(!n)return this.debugNodeNotFound(o,i);const a=(0,c.getBaseDimension)(n,this.iframe),r=e*a.absoluteScale+a.x,l=t*a.absoluteScale+a.y;this.mouse.style.left=`${r}px`,this.mouse.style.top=`${l}px`,s||this.drawMouseTail({x:r,y:l}),this.hoverElements(n)}drawMouseTail(e){if(!this.mouseTail)return;const{lineCap:t,lineWidth:i,strokeStyle:s,duration:o}=!0===this.config.mouseTail?g:Object.assign({},g,this.config.mouseTail),n=()=>{if(!this.mouseTail)return;const e=this.mouseTail.getContext("2d");e&&this.tailPositions.length&&(e.clearRect(0,0,this.mouseTail.width,this.mouseTail.height),e.beginPath(),e.lineWidth=i,e.lineCap=t,e.strokeStyle=s,e.moveTo(this.tailPositions[0].x,this.tailPositions[0].y),this.tailPositions.forEach((t=>e.lineTo(t.x,t.y))),e.stroke())};this.tailPositions.push(e),n(),setTimeout((()=>{this.tailPositions=this.tailPositions.filter((t=>t!==e)),n()}),o/this.speedService.state.context.timer.speed)}hoverElements(e){var t;null===(t=this.lastHoveredRootNode||this.iframe.contentDocument)||void 0===t||t.querySelectorAll(".\\:hover").forEach((e=>{e.classList.remove(":hover")})),this.lastHoveredRootNode=e.getRootNode();let i=e;for(;i;)i.classList&&i.classList.add(":hover"),i=i.parentElement}isUserInteraction(e){return e.type===d.Bx.IncrementalSnapshot&&(e.data.source>d.Cj.Mutation&&e.data.source<=d.Cj.Input)}backToNormal(){this.nextUserInteractionEvent=null,this.speedService.state.matches("normal")||(this.speedService.send({type:"BACK_TO_NORMAL"}),this.emitter.emit(d.Y$.SkipEnd,{speed:this.speedService.state.context.normalSpeed}))}warnNodeNotFound(e,t){this.warn(`Node with id '${t}' not found. `,e)}warnCanvasMutationFailed(e,t){this.warn("Has error on canvas update",t,"canvas mutation:",e)}debugNodeNotFound(e,t){this.debug(`Node with id '${t}' not found. `,e)}warn(...e){this.config.showWarning&&this.config.logger.warn(y,...e)}debug(...e){this.config.showDebug&&this.config.logger.log(y,...e)}}}}]);
//# sourceMappingURL=https://www.scribd.com/webpack/monolith/5327.3d97cb383a9b6651b153.js.map